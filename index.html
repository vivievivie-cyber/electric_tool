<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ˆæ¥­é›»å·¥ç·šå¾‘èˆ‡ç®¡å¾‘è¦åŠƒç³»çµ± (V4.0 è¡Œå‹•ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #007bff;
            --accent: #dc3545;
            --success: #28a745;
            --bg: #f4f6f9;
        }

        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; -webkit-text-size-adjust: 100%; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        h1 { font-size: 1.6rem; margin-bottom: 5px; text-align: center; color: var(--primary); }
        .subtitle { text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 25px; }

        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab { flex: 1; padding: 15px 5px; cursor: pointer; text-align: center; font-weight: bold; color: #777; transition: 0.3s; background: #fafafa; font-size: 1rem; }
        .tab.active { color: var(--secondary); border-bottom: 3px solid var(--secondary); background: #fff; }

        .panel { display: none; animation: fadeIn 0.4s; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        
        /* è¼¸å…¥æ¡†å„ªåŒ– */
        select, input { 
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; 
            font-size: 16px; /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
            box-sizing: border-box; 
            background: #fff;
        }
        
        .highlight-box { background: #eef6fc; padding: 15px; border-radius: 8px; border-left: 5px solid var(--secondary); margin-bottom: 20px; }
        
        button.btn-calc { width: 100%; padding: 15px; background: var(--secondary); color: white; border: none; border-radius: 6px; font-size: 1.1rem; cursor: pointer; transition: 0.2s; font-weight: bold; margin-top: 10px; }
        button.btn-calc:hover { background: #0056b3; }
        button.btn-calc:active { transform: scale(0.98); }

        .result-card { margin-top: 20px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; display: none; }
        .result-header { background: var(--primary); color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; }
        .result-body { padding: 20px; }
        .result-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 10px; align-items: center;}
        .result-row:last-child { border: none; }
        .result-row span:first-child { color: #555; font-size: 0.95rem; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; color: white; }
        .bg-ok { background: var(--success); }

        /* ç®¡å¾‘è¨ˆç®—åˆ—è¡¨ */
        .wire-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .wire-row select { flex: 2; }
        .wire-row input { flex: 1; text-align: center; }
        .add-btn { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <h1>âš¡ ç·šå¾‘èˆ‡ç®¡å¾‘è¦åŠƒ V4.0</h1>
    <p class="subtitle">æ‰‹æ©Ÿæœ€ä½³åŒ– | è‡ªå‹•å¸¶å…¥ç·šå¾‘ | EMT/GIP è¦æ ¼</p>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('wire-sizing')">1. ç·šå¾‘é¸å®š</div>
        <div class="tab" onclick="switchTab('conduit-sizing')">2. ç®¡å¾‘è¨ˆç®—</div>
    </div>

    <div id="wire-sizing" class="panel active">
        
        <div class="highlight-box">
            <label style="font-size: 1.1rem; color: var(--primary);">è¨­å®šç„¡ç†”çµ²é–‹é—œå®¹é‡ (AT):</label>
            <input type="number" inputmode="numeric" pattern="[0-9]*" id="breaker-at" placeholder="ä¾‹å¦‚: 50, 100..." style="font-size: 1.4rem; font-weight: bold; text-align: center;">
            <small style="color: #555; display:block; margin-top:5px; text-align:center;">â€» ç³»çµ±å°‡ä¾æ­¤æ•¸å€¼æ±ºå®šä¸»ç·šå¾‘</small>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label>å°ç·šé…ç½®æ–¹å¼ (ç·šç¨®):</label>
                <select id="wire-type">
                    <option value="pvc_core">1. PVC å–®èŠ¯é›»ç·š (60Â°C)</option>
                    <option value="pvc_cable">2. PVC é›»çºœç·š (60Â°C)</option>
                    <option value="xlpe">3. XLPE é›»ç·š (90Â°C)</option>
                    <option value="hr">4. HR è€ç†±é›»ç·š (90Â°C)</option>
                    <option value="fr">5. FR è€ç‡ƒé›»ç·š (90Â°C)</option>
                </select>
            </div>

            <div class="form-group">
                <label>æ–°å¢é…ç®¡æ–¹å¼ (æ•·è¨­ç’°å¢ƒ):</label>
                <select id="install-method">
                    <option value="pvc_pipe">1. PVC é…ç®¡ (æ•£ç†±è¼ƒå·®)</option>
                    <option value="metal_pipe">2. é‡‘å±¬ç®¡ é…ç®¡ (æ•£ç†±è¼ƒå¥½)</option>
                    <option value="tray">3. é›»çºœç·šæ¶ (é€šé¢¨è‰¯å¥½)</option>
                    <option value="trunking">4. é›»çºœç·šæ§½ (Wireway)</option>
                </select>
            </div>

            <div class="form-group">
                <label>ç³»çµ±é›»å£“ (Volts):</label>
                <select id="voltage">
                    <option value="110">110V (å–®ç›¸äºŒç·š)</option>
                    <option value="220" selected>220V (å–®ç›¸/ä¸‰ç›¸)</option>
                    <option value="380">380V (ä¸‰ç›¸)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>å–®ç¨‹ç·šè·¯é•·åº¦ (å…¬å°º):</label>
                <input type="number" inputmode="decimal" pattern="[0-9]*" id="wire-length" value="10" placeholder="è·é›¢">
            </div>
        </div>

        <button class="btn-calc" onclick="calculateWireSize()">è¨ˆç®—å»ºè­°ä¸»ç·šèˆ‡æ¥åœ°ç·š</button>

        <div id="wire-result" class="result-card">
            <div class="result-header">
                <span>è¦åŠƒå»ºè­°æ›¸</span>
                <span id="wire-status-badge" class="badge bg-ok">è¨ˆç®—å®Œæˆ</span>
            </div>
            <div class="result-body">
                <div class="result-row">
                    <span>âš¡ å»ºè­°ä¸»ç·šå¾‘ï¼š</span>
                    <strong id="res-main-wire" style="font-size: 1.1rem; color: var(--secondary); text-align:right;">--</strong>
                </div>
                <div class="result-row">
                    <span>ğŸ”„ è¿´è·¯é…ç½®ï¼š</span>
                    <strong id="res-wire-sets" style="color: #333;">--</strong>
                </div>
                <div class="result-row">
                    <span>ğŸ›¡ï¸ å»ºè­°æ¥åœ°ç·šï¼š</span>
                    <strong id="res-ground-wire" style="color: #28a745;">--</strong>
                </div>
                <div class="result-row">
                    <span>ğŸ”Œ å®‰åŸ¹å®¹é‡ï¼š</span>
                    <span id="res-amp-check">--</span>
                </div>
                <div class="result-row">
                    <span>ğŸ“‰ å£“é™ä¼°ç®—ï¼š</span>
                    <span id="res-voltage-drop">--</span>
                </div>
                <div id="upsize-msg" style="color: var(--accent); font-weight: bold; margin-top: 10px; display: none; background: #fff3cd; padding: 10px; border-radius: 5px; font-size: 0.9rem;">
                    âš ï¸ å› å£“é™éå¤§ï¼Œç³»çµ±å·²è‡ªå‹•å°‡ç·šå¾‘åŠ å¤§ä¸€ç´šã€‚
                </div>
            </div>
        </div>
    </div>

    <div id="conduit-sizing" class="panel">
        <div class="highlight-box" style="border-left-color: #28a745;">
            <p style="margin:0; font-weight:bold;">å°ç·šç®¡å¾‘è¨ˆç®— (ä½”ç©ç‡ 40%)</p>
            <p style="margin:5px 0 0; font-size:0.9rem; color:#666;">â€» ä¸»ç·šå¾‘é è¨­ç‚ºä¸Šä¸€é è¨ˆç®—çµæœï¼Œè«‹è¼¸å…¥æ•¸é‡ã€‚</p>
        </div>

        <div id="wire-list-container"></div>
        
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button type="button" class="add-btn" onclick="addWireRow()">+ ä¸»é›»ç·š</button>
            <button type="button" class="add-btn" style="background:#6c757d" onclick="addGroundRow()">+ æ¥åœ°ç·š</button>
        </div>

        <br><br>
        <button class="btn-calc" onclick="calculateConduitSize()">è¨ˆç®—å»ºè­°ç®¡å¾‘</button>

        <div id="conduit-result" class="result-card">
            <div class="result-header">
                <span>å»ºè­°ç®¡å¾‘æ–¹æ¡ˆ</span>
                <span class="badge bg-ok">ä½”ç©ç‡ < 40%</span>
            </div>
            <div class="result-body">
                <div class="result-row">
                    <span>ç¸½æˆªé¢ç© (å«çš®)ï¼š</span>
                    <strong id="res-total-area">-- mmÂ²</strong>
                </div>
                <div class="result-row" style="background: #fff3cd; padding: 8px;">
                    <span>ğŸŸ  PVC é…ç®¡ï¼š</span>
                    <strong id="res-pvc-pipe" style="font-size: 1.2rem; color: #d35400;">--</strong>
                </div>
                <div class="result-row" style="background: #d4edda; padding: 8px;">
                    <span>âšª EMT/GIP é‡‘å±¬ç®¡ï¼š</span>
                    <strong id="res-metal-pipe" style="font-size: 1.2rem; color: #155724;">--</strong>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // ==========================================
    // å…¨åŸŸè®Šæ•¸ï¼šå„²å­˜æœ€å¾Œä¸€æ¬¡è¨ˆç®—å‡ºçš„ç·šå¾‘ (ç”¨æ–¼è‡ªå‹•å¸¶å…¥)
    // ==========================================
    let lastCalculatedSize = null; 

    // ==========================================
    // 1. è³‡æ–™åº« 
    // ==========================================
    const wireData = [
        { size: 1.6, label: "1.6mm", R: 8.9, outer_area: 10, pvc_amps: { pvc_pipe: 15, metal: 15, tray: 15 }, xlpe_amps: { pvc_pipe: 20, metal: 20, tray: 25 } },
        { size: 2.0, label: "2.0mm", R: 5.6, outer_area: 12, pvc_amps: { pvc_pipe: 20, metal: 20, tray: 20 }, xlpe_amps: { pvc_pipe: 30, metal: 30, tray: 35 } },
        { size: 3.5, label: "3.5mmÂ²", R: 6.0, outer_area: 16, pvc_amps: { pvc_pipe: 20, metal: 20, tray: 30 }, xlpe_amps: { pvc_pipe: 30, metal: 35, tray: 40 } },
        { size: 5.5, label: "5.5mmÂ²", R: 3.8, outer_area: 20, pvc_amps: { pvc_pipe: 25, metal: 30, tray: 40 }, xlpe_amps: { pvc_pipe: 40, metal: 45, tray: 55 } },
        { size: 8, label: "8mmÂ²", R: 2.6, outer_area: 28, pvc_amps: { pvc_pipe: 33, metal: 40, tray: 55 }, xlpe_amps: { pvc_pipe: 50, metal: 55, tray: 70 } },
        { size: 14, label: "14mmÂ²", R: 1.5, outer_area: 45, pvc_amps: { pvc_pipe: 50, metal: 55, tray: 75 }, xlpe_amps: { pvc_pipe: 75, metal: 80, tray: 95 } },
        { size: 22, label: "22mmÂ²", R: 0.96, outer_area: 70, pvc_amps: { pvc_pipe: 60, metal: 70, tray: 95 }, xlpe_amps: { pvc_pipe: 95, metal: 105, tray: 125 } },
        { size: 30, label: "30mmÂ²", R: 0.70, outer_area: 90, pvc_amps: { pvc_pipe: 75, metal: 85, tray: 115 }, xlpe_amps: { pvc_pipe: 110, metal: 125, tray: 150 } },
        { size: 38, label: "38mmÂ²", R: 0.56, outer_area: 110, pvc_amps: { pvc_pipe: 85, metal: 100, tray: 130 }, xlpe_amps: { pvc_pipe: 130, metal: 145, tray: 175 } },
        { size: 50, label: "50mmÂ²", R: 0.43, outer_area: 140, pvc_amps: { pvc_pipe: 100, metal: 115, tray: 160 }, xlpe_amps: { pvc_pipe: 150, metal: 170, tray: 205 } },
        { size: 60, label: "60mmÂ²", R: 0.35, outer_area: 165, pvc_amps: { pvc_pipe: 115, metal: 135, tray: 185 }, xlpe_amps: { pvc_pipe: 170, metal: 195, tray: 235 } },
        { size: 80, label: "80mmÂ²", R: 0.27, outer_area: 200, pvc_amps: { pvc_pipe: 135, metal: 160, tray: 215 }, xlpe_amps: { pvc_pipe: 200, metal: 230, tray: 275 } },
        { size: 100, label: "100mmÂ²", R: 0.21, outer_area: 240, pvc_amps: { pvc_pipe: 160, metal: 185, tray: 250 }, xlpe_amps: { pvc_pipe: 240, metal: 270, tray: 325 } },
        { size: 125, label: "125mmÂ²", R: 0.17, outer_area: 280, pvc_amps: { pvc_pipe: 190, metal: 215, tray: 290 }, xlpe_amps: { pvc_pipe: 280, metal: 315, tray: 380 } },
        { size: 150, label: "150mmÂ²", R: 0.14, outer_area: 330, pvc_amps: { pvc_pipe: 215, metal: 245, tray: 325 }, xlpe_amps: { pvc_pipe: 315, metal: 360, tray: 430 } },
        { size: 200, label: "200mmÂ²", R: 0.11, outer_area: 410, pvc_amps: { pvc_pipe: 260, metal: 295, tray: 400 }, xlpe_amps: { pvc_pipe: 380, metal: 430, tray: 520 } },
        { size: 250, label: "250mmÂ²", R: 0.09, outer_area: 500, pvc_amps: { pvc_pipe: 300, metal: 340, tray: 460 }, xlpe_amps: { pvc_pipe: 440, metal: 500, tray: 600 } },
        { size: 325, label: "325mmÂ²", R: 0.07, outer_area: 630, pvc_amps: { pvc_pipe: 350, metal: 400, tray: 540 }, xlpe_amps: { pvc_pipe: 520, metal: 590, tray: 700 } },
        { size: 400, label: "400mmÂ²", R: 0.06, outer_area: 760, pvc_amps: { pvc_pipe: 400, metal: 450, tray: 600 }, xlpe_amps: { pvc_pipe: 600, metal: 680, tray: 800 } },
        { size: 500, label: "500mmÂ²", R: 0.05, outer_area: 950, pvc_amps: { pvc_pipe: 450, metal: 520, tray: 700 }, xlpe_amps: { pvc_pipe: 700, metal: 780, tray: 900 } }
    ];

    const groundingTable = [
        { breakerAt: 20, groundSize: "1.6mm" }, { breakerAt: 30, groundSize: "2.0mm" }, 
        { breakerAt: 40, groundSize: "5.5mmÂ²" }, { breakerAt: 60, groundSize: "5.5mmÂ²" },
        { breakerAt: 100, groundSize: "8mmÂ²" }, { breakerAt: 200, groundSize: "14mmÂ²" },
        { breakerAt: 300, groundSize: "22mmÂ²" }, { breakerAt: 400, groundSize: "30mmÂ²" }, 
        { breakerAt: 500, groundSize: "38mmÂ²" }, { breakerAt: 600, groundSize: "50mmÂ²" },
        { breakerAt: 800, groundSize: "60mmÂ²" }
    ];

    // ç®¡å¾‘è¦æ ¼è¡¨ (ä¾ç…§ EMT/GIP æ¨™ç¤º)
    const pipeSpecs = [
        { name: '1/2" (16mm)', maxArea: 100 }, 
        { name: '3/4" (22mm)', maxArea: 210 },
        { name: '1" (28mm)', maxArea: 370 }, 
        { name: '1-1/4" (36mm)', maxArea: 650 },
        { name: '1-1/2" (42mm)', maxArea: 900 }, 
        { name: '2" (54mm)', maxArea: 1450 },
        { name: '2-1/2" (70mm)', maxArea: 2100 }, 
        { name: '3" (82mm)', maxArea: 3200 },
        { name: '3-1/2" (92mm)', maxArea: 4200 }, 
        { name: '4" (104mm)', maxArea: 5300 },
        { name: '5" (125mm)', maxArea: 8000 }, 
        { name: '6" (150mm)', maxArea: 11500 }
    ];

    // ç·šç¨®åç¨±å°ç…§è¡¨ (ç”¨æ–¼é¡¯ç¤ºçµæœå‰ç¶´)
    const wireTypeLabels = {
        'pvc_core': 'PVCå–®èŠ¯',
        'pvc_cable': 'PVCé›»çºœ',
        'xlpe': 'XLPE',
        'hr': 'HRè€ç†±',
        'fr': 'FRè€ç‡ƒ'
    };

    // ==========================================
    // 2. åŠŸèƒ½å‡½æ•¸
    // ==========================================

    function switchTab(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');

        // å¦‚æœåˆ‡æ›åˆ°ç®¡å¾‘è¨ˆç®—é ï¼Œå˜—è©¦è‡ªå‹•åŒæ­¥ç¬¬ä¸€å€‹é¸å–®
        if (id === 'conduit-sizing' && lastCalculatedSize) {
            updateFirstWireSelect(lastCalculatedSize);
        }
    }

    function getWireOptions() {
        if (!wireData || wireData.length === 0) return '<option disabled>è³‡æ–™è¼‰å…¥ä¸­...</option>';
        return wireData.map(w => `<option value="${w.size}">${w.label}</option>`).join('');
    }

    function addWireRow(defaultSize = null) {
        const container = document.getElementById('wire-list-container');
        if(!container) return;
        const div = document.createElement('div');
        div.className = 'wire-row';
        div.innerHTML = `
            <select class="conduit-wire-select">
                <option value="" disabled ${!defaultSize ? 'selected' : ''}>é¸æ“‡ä¸»ç·šå¾‘...</option>
                ${wireData.map(w => `<option value="${w.size}" ${w.size === defaultSize ? 'selected' : ''}>${w.label}</option>`).join('')}
            </select>
            <input type="number" inputmode="numeric" pattern="[0-9]*" class="conduit-wire-qty" placeholder="æ•¸é‡" value="" min="0">
            <button onclick="this.parentElement.remove()" style="border:none;background:none;color:#dc3545;cursor:pointer;font-weight:bold;font-size:1.2rem;">âœ•</button>
        `;
        container.appendChild(div);
    }
    
    function addGroundRow() {
        const container = document.getElementById('wire-list-container');
        const div = document.createElement('div');
        div.className = 'wire-row';
        div.innerHTML = `
            <select class="conduit-wire-select">
                <option value="" disabled selected>é¸æ“‡æ¥åœ°ç·š...</option>
                 ${getWireOptions()}
            </select>
            <input type="number" inputmode="numeric" pattern="[0-9]*" class="conduit-wire-qty" value="1" placeholder="æ•¸é‡">
            <span style="font-size:0.8rem; color:#28a745; white-space:nowrap;">(æ¥åœ°)</span>
            <button onclick="this.parentElement.remove()" style="border:none;background:none;color:#dc3545;cursor:pointer;font-weight:bold;font-size:1.2rem;">âœ•</button>
        `;
        container.appendChild(div);
    }

    // è‡ªå‹•æ›´æ–°ç¬¬ä¸€åˆ—çš„ç·šå¾‘
    function updateFirstWireSelect(size) {
        const selects = document.querySelectorAll('#wire-list-container .conduit-wire-select');
        // æ‰¾åˆ°ç¬¬ä¸€å€‹ä¸‹æ‹‰é¸å–® (å‡è¨­æ˜¯ä¸»ç·š)
        if (selects.length > 0) {
            selects[0].value = size;
            // è¦–è¦ºæç¤ºï¼šé–ƒçˆä¸€ä¸‹
            selects[0].style.backgroundColor = "#e8f0fe";
            setTimeout(() => selects[0].style.backgroundColor = "#fff", 500);
        }
    }

    // ==========================================
    // 3. æ ¸å¿ƒè¨ˆç®—ï¼šç·šå¾‘
    // ==========================================
    function calculateWireSize() {
        const breakerAt = parseFloat(document.getElementById('breaker-at').value);
        const wireType = document.getElementById('wire-type').value; 
        const installMethod = document.getElementById('install-method').value;
        const voltage = parseFloat(document.getElementById('voltage').value);
        const length = parseFloat(document.getElementById('wire-length').value);

        if (!breakerAt) { alert("è«‹è¼¸å…¥ç„¡ç†”çµ²é–‹é—œå®¹é‡ (AT)"); return; }

        let selectedWire = null;
        let finalVoltageDrop = 0;
        let isUpsized = false;
        let sets = 1; 

        const useXlpeTable = ['xlpe', 'hr', 'fr'].includes(wireType);
        
        let ampColumn = 'metal'; 
        if (installMethod === 'pvc_pipe') ampColumn = 'pvc_pipe';
        else if (installMethod === 'tray') ampColumn = 'tray';
        else ampColumn = 'metal'; 

        // æ‰¾ç·šé‚è¼¯
        let currentTarget = breakerAt;
        let singleWireOption = findWireForCurrent(currentTarget, useXlpeTable, ampColumn);

        // ä¸¦è¯åˆ¤æ–·
        if (!singleWireOption || singleWireOption.size > 200) {
            sets = 2; 
            currentTarget = breakerAt / 2;
            selectedWire = findWireForCurrent(currentTarget, useXlpeTable, ampColumn);
            if (!selectedWire) {
                alert("å³ä¾¿ä½¿ç”¨é›™çµ„ä¸¦è¯ï¼Œä»æ‰¾ä¸åˆ°åˆé©ç·šå¾‘ï¼Œè«‹è«®è©¢æŠ€å¸«ã€‚");
                return;
            }
        } else {
            selectedWire = singleWireOption;
        }

        // å£“é™æª¢æŸ¥
        while (true) {
            let resistance = selectedWire.R;
            if (sets === 2) resistance = resistance / 2; 

            let dropVal = (2 * length * breakerAt * resistance) / 1000;
            let dropPercent = (dropVal / voltage) * 100;

            if (dropPercent < 3.0) {
                finalVoltageDrop = dropPercent;
                break; 
            } else {
                let nextWire = getNextLargerWire(selectedWire.size);
                if (nextWire) {
                    selectedWire = nextWire;
                    selectedWire.capacity = getWireCapacity(selectedWire, useXlpeTable, ampColumn);
                    isUpsized = true;
                } else {
                    finalVoltageDrop = dropPercent; 
                    break; 
                }
            }
        }

        // æ¥åœ°ç·š
        let groundWireSize = "è«‹è«®è©¢æŠ€å¸«";
        for (let g of groundingTable) {
            if (g.breakerAt >= breakerAt) {
                groundWireSize = g.groundSize;
                break;
            }
        }
        if (breakerAt > 800) groundWireSize = "éœ€ä¾è¨ˆç®—å…¬å¼";

        // å„²å­˜çµæœä¾›è‡ªå‹•å¸¶å…¥
        lastCalculatedSize = selectedWire.size;

        // é¡¯ç¤ºçµæœ
        const resCard = document.getElementById('wire-result');
        resCard.style.display = 'block';

        if (selectedWire) {
            // åŠ ä¸Šç·šç¨®å‰ç¶´
            const typeLabel = wireTypeLabels[wireType] || "";
            document.getElementById('res-main-wire').innerText = `${typeLabel} é›»ç·š ${selectedWire.label}`;
            
            const setsElem = document.getElementById('res-wire-sets');
            if (sets === 2) {
                setsElem.innerText = "2 çµ„ä¸¦è¯ (è‡ªå‹•æ‹†åˆ†)";
                setsElem.style.color = "#d35400";
            } else {
                setsElem.innerText = "1 çµ„ (å–®è¿´è·¯)";
                setsElem.style.color = "#333";
            }

            document.getElementById('res-ground-wire').innerText = groundWireSize;
            
            const dropElem = document.getElementById('res-voltage-drop');
            dropElem.innerText = finalVoltageDrop.toFixed(2) + '%';
            dropElem.style.color = finalVoltageDrop > 2.5 ? '#d35400' : '#27ae60';

            let totalCapacity = selectedWire.capacity * sets;
            document.getElementById('res-amp-check').innerText = `${breakerAt}A / è€æµ ${totalCapacity}A`;
            
            const msg = document.getElementById('upsize-msg');
            msg.style.display = isUpsized ? 'block' : 'none';
        }
    }

    function getWireCapacity(wire, useXlpeTable, ampColumn) {
        if (useXlpeTable) return wire.xlpe_amps[ampColumn];
        return wire.pvc_amps[ampColumn];
    }

    function findWireForCurrent(targetAmps, useXlpeTable, ampColumn) {
        for (let wire of wireData) {
            let capacity = getWireCapacity(wire, useXlpeTable, ampColumn);
            wire.capacity = capacity;
            if (capacity >= targetAmps) return wire;
        }
        return null; 
    }

    function getNextLargerWire(currentSize) {
        let index = wireData.findIndex(w => w.size === currentSize);
        if (index !== -1 && index < wireData.length - 1) {
            return wireData[index + 1];
        }
        return null;
    }

    // ==========================================
    // 4. æ ¸å¿ƒè¨ˆç®—ï¼šç®¡å¾‘
    // ==========================================
    function calculateConduitSize() {
        let totalArea = 0;
        const rows = document.querySelectorAll('.wire-row');
        
        rows.forEach(row => {
            const select = row.querySelector('select');
            const input = row.querySelector('input');
            const size = parseFloat(select.value);
            const qty = parseFloat(input.value);
            
            if (size && qty) {
                const wire = wireData.find(w => w.size === size);
                if (wire) totalArea += wire.outer_area * qty;
            }
        });

        if (totalArea === 0) { alert("è«‹è¼¸å…¥æ•¸é‡"); return; }

        let pvcResult = "éœ€æ›´å¤§ç®¡å¾‘";
        let metalResult = "éœ€æ›´å¤§ç®¡å¾‘";

        for (let pipe of pipeSpecs) {
            if (pipe.maxArea >= totalArea) {
                 if (pvcResult === "éœ€æ›´å¤§ç®¡å¾‘") pvcResult = pipe.name;
                 if (metalResult === "éœ€æ›´å¤§ç®¡å¾‘") metalResult = pipe.name;
                 break;
            }
        }

        document.getElementById('conduit-result').style.display = 'block';
        document.getElementById('res-total-area').innerText = totalArea.toFixed(1) + " mmÂ²";
        document.getElementById('res-pvc-pipe').innerText = pvcResult;
        document.getElementById('res-metal-pipe').innerText = metalResult;
    }

    window.addEventListener('load', function() {
        addWireRow(); 
    });

</script>

</body>
</html>
