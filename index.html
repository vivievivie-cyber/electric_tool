<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç·šå¾‘èˆ‡ç®¡å¾‘è¦åŠƒè¨ˆç®—æ©Ÿ (Liquid)</title>
    <style>
        /* --- å…¨åŸŸè¨­å®š & å‹•æ…‹èƒŒæ™¯ --- */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --primary-color: #007AFF; /* Apple Blue */
            --text-main: #1d1d1f;
            --text-sub: #86868b;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; padding: 20px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh; color: var(--text-main);
            overflow-x: hidden;
            padding-bottom: 100px;
        }

        /* å‹•æ…‹æµé«”èƒŒæ™¯çƒ */
        .blob {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; overflow: hidden;
        }
        .blob div {
            position: absolute; border-radius: 50%; filter: blur(60px); opacity: 0.6;
            animation: float 10s infinite ease-in-out alternate;
        }
        .blob div:nth-child(1) { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #a1c4fd; }
        .blob div:nth-child(2) { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #c2e9fb; animation-delay: -5s; }
        .blob div:nth-child(3) { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #e0c3fc; animation-duration: 15s; }

        @keyframes float { from { transform: translate(0, 0); } to { transform: translate(30px, 50px); } }

        /* --- æ¨™é¡Œ --- */
        .header-container { text-align: center; margin-bottom: 30px; position: relative; z-index: 2; }
        h1 { 
            margin: 0; font-size: 1.8rem; font-weight: 700; 
            background: linear-gradient(135deg, #007AFF, #00C6FB); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }
        
        .help-btn {
            background: rgba(255,255,255,0.8); border: 1px solid #fff; 
            width: 28px; height: 28px; border-radius: 50%; 
            color: #007AFF; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: absolute; right: 10px; top: 5px;
            display: flex; align-items: center; justify-content: center;
        }

        /* --- æ¶²æ…‹ç»ç’ƒå¡ç‰‡ (Glassmorphism) --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 25px;
            box-shadow: var(--glass-shadow);
            margin-bottom: 25px;
            position: relative; z-index: 2;
            transition: transform 0.3s ease;
        }

        /* --- è¼¸å…¥å…ƒä»¶è¨­è¨ˆ --- */
        .input-group { margin-bottom: 18px; }
        label { 
            display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-sub); 
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        select, input[type="number"] { 
            width: 100%; padding: 14px; 
            border: 1px solid rgba(255,255,255,0.6); 
            border-radius: 16px;
            font-size: 17px; 
            background: rgba(255, 255, 255, 0.4);
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.03), 0 5px 10px rgba(0,0,0,0.02);
            color: #333; box-sizing: border-box; appearance: none;
            transition: all 0.3s ease;
        }
        select:focus, input:focus { 
            outline: none; border-color: #007AFF; background: rgba(255,255,255,0.8);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.15);
        }

        /* --- æŒ‰éˆ•è¨­è¨ˆ --- */
        .btn { 
            display: block; width: 100%; padding: 16px; border: none; border-radius: 18px; 
            font-size: 1.1rem; font-weight: 600; cursor: pointer; color: white; margin-top: 10px;
            background: linear-gradient(135deg, #007AFF, #005ecb);
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.3);
            transition: all 0.2s ease;
        }
        .btn:active { transform: scale(0.98); box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2); }

        /* --- çµæœå€å¡Š --- */
        .result-section { display: none; animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .res-block { 
            border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 20px; margin-bottom: 20px; 
        }
        .res-block:last-child { border-bottom: none; margin-bottom: 0; }
        
        .res-title { font-size: 0.85rem; color: #86868b; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; }
        .res-value { 
            font-size: 1.8rem; font-weight: 700; color: #1d1d1f; margin-bottom: 5px; 
            background: linear-gradient(90deg, #1d1d1f, #434343); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .res-detail { font-size: 0.95rem; color: #515154; line-height: 1.6; }
        
        .tag { 
            display: inline-block; padding: 4px 10px; border-radius: 20px; 
            font-size: 0.75rem; font-weight: bold; margin-left: 8px; vertical-align: middle;
            color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .tag-auto { background: linear-gradient(135deg, #FF9500, #FF5E3A); }
        .tag-manual { background: linear-gradient(135deg, #34C759, #30B34A); }

        /* --- Modal --- */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: #fff; margin: 20px; padding: 30px; border-radius: 24px;
            width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .close-modal { position: absolute; top: 15px; right: 20px; color: #aaa; font-size: 28px; cursor: pointer; }
        h2 { margin-top: 0; color: #1d1d1f; border-bottom: 2px solid #f5f5f7; padding-bottom: 15px; }
        
        /* Highlight text */
        .highlight { color: #007AFF; font-weight: bold; }
    </style>
</head>
<body>

    <div class="blob">
        <div></div><div></div><div></div>
    </div>

    <div class="header-container">
        <h1>ç·šå¾‘èˆ‡ç®¡å¾‘è¦åŠƒè¨ˆç®—æ©Ÿ</h1>
        <button class="help-btn" onclick="openModal()">?</button>
    </div>

    <div class="glass-card">
        <div class="input-group">
            <label>1. ç„¡ç†”çµ²é–‹é—œ (NFB AT)</label>
            <input type="number" id="nfbValue" placeholder="è¼¸å…¥ AT å€¼ (å¦‚ 50, 400)" inputmode="decimal">
        </div>

        <div class="input-group">
            <label>2. é›»ç·šå®‰å…¨ä¿‚æ•¸</label>
            <input type="number" id="safetyFactor" value="1.2" step="0.05" placeholder="æ­£å¸¸ç‚º 1.2">
        </div>

        <div class="input-group">
            <label>3. è¿´è·¯é…ç½®æ–¹å¼</label>
            <select id="circuitConfig">
                <option value="auto">âœ¨ è‡ªå‹•è¨ˆç®— (é™åˆ¶å–®ç·š < 200mmÂ²)</option>
                <option value="1">1 è¿´è·¯ (å¼·åˆ¶)</option>
                <option value="2">2 è¿´è·¯ (å¼·åˆ¶)</option>
                <option value="3">3 è¿´è·¯ (å¼·åˆ¶)</option>
                <option value="4">4 è¿´è·¯ (å¼·åˆ¶)</option>
            </select>
        </div>

        <div class="input-group">
            <label>4. çµ•ç·£å°ç·šç¨®é¡</label>
            <select id="wireType">
                <option value="xlpe">XLPE é›»çºœ (PEX/CV) - 90Â°C</option>
                <option value="pvc_wire">PVC é›»ç·š (IV) - 60Â°C</option>
                <option value="pvc_cable">PVC é›»çºœ (VV) - 60Â°C</option>
            </select>
        </div>
        
        <div class="input-group">
            <label>5. å®¹å™¨èˆ‡å°ç·šæ•¸</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="containerType" onchange="updateHint()">
                    <option value="conduit_emt">å°ç·šç®¡ (EMT)</option>
                    <option value="conduit_pvc">å°ç·šç®¡ (PVC)</option>
                    <option value="conduit_rsc">å°ç·šç®¡ (RSG)</option>
                    <option value="tray">é‡‘å±¬ç·šæ§½</option>
                </select>
                <select id="wireCountSelect">
                    <option value="3">3 æ¢ (ä¸å«G)</option>
                    <option value="4">4 æ¢ (ä¸å«G)</option>
                </select>
            </div>
            <div id="containerHint" style="font-size:0.8rem; color:#666; margin-top:5px; text-align:right;">
                å¡«å……ç‡ 40%
            </div>
        </div>

        <button class="btn" onclick="calculate()">è‡ªå‹•è¨ˆç®—</button>
    </div>

    <div id="resultArea" class="result-section glass-card">
        
        <div class="res-block">
            <div class="res-title">æ­¥é©Ÿä¸€ï¼šå»ºè­°ä¸»ç·šå¾‘ (R/S/T/N)</div>
            <div style="display:flex; align-items:center;">
                <div class="res-value" id="resWireSize">---</div>
                <div id="configTag"></div>
            </div>
            <div class="res-detail">
                <div>ç›®æ¨™ç¸½å®¹é‡ï¼š<span id="resTargetTotal" class="highlight">0</span> A <span style="font-size:0.8em;color:#888;">(å«1.2å€ä¿‚æ•¸)</span></div>
                <div>æŸ¥è¡¨çµæœï¼š<span id="resCalcDetailLine"></span></div>
            </div>
        </div>

        <div class="res-block">
            <div class="res-title">æ­¥é©ŸäºŒï¼šéŠ…æ¥åœ°ç·š (G)</div>
            <div class="res-value" id="resGroundSize" style="color:#34C759; -webkit-text-fill-color: #34C759;">---</div>
            <div class="res-detail">
                <div>ä¾æ“šï¼šåœ–å¡å°ç…§è¡¨ (NFB <span id="resNFBDisplay">0</span>A)</div>
            </div>
        </div>

        <div class="res-block">
            <div class="res-title">æ­¥é©Ÿä¸‰ï¼šå»ºè­°å®¹å™¨é…ç½®</div>
            <div class="res-value" id="resContainerSize">---</div>
            <div class="res-detail">
                <div id="resPipeNote" style="display:none; color:#FF9500; font-weight:bold; margin-bottom:5px;">
                    ğŸ’¡ å»ºè­°é…ç½® <span id="resPipeCount">1</span> æ”¯ç®¡ (æ¯ç®¡ä¸€è¿´è·¯)
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>ç¸½æˆªé¢ç©ï¼š<span id="resTotalArea">0</span> mmÂ²</span>
                    <span>å¡«å……ç‡ï¼š<span id="resFillRate" class="highlight">0%</span></span>
                </div>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('helpModal').style.display='none'">&times;</span>
            <h2>è¨­å®šèªªæ˜</h2>
            <p><strong>1. å®‰å…¨ä¿‚æ•¸ï¼š</strong><br>é è¨­ <strong>1.2 å€</strong> (NFB x 1.2)ã€‚å¯ä¾éœ€æ±‚æ‰‹å‹•èª¿æ•´ã€‚</p>
            <p><strong>2. è¿´è·¯é…ç½®ï¼š</strong></p>
            <ul>
                <li><strong>è‡ªå‹•ï¼š</strong> å„ªå…ˆé¸ 1 è¿´è·¯ï¼Œè‹¥ç·šå¾‘ > 200mmÂ² å‰‡è‡ªå‹•æ‹†åˆ†ç‚ºå¤šè¿´è·¯ã€‚</li>
                <li><strong>å¼·åˆ¶æŒ‡å®šï¼š</strong> å¼·åˆ¶è¨ˆç®—æ‚¨é¸æ“‡çš„è¿´è·¯æ•¸ï¼Œå³ä½¿ç·šå¾‘æ¥µå¤§æˆ–æ¥µå°ã€‚</li>
            </ul>
            <p><strong>3. æ•¸æ“šä¾æ“šï¼š</strong><br>æ¡ç”¨ç¾å ´é€ŸæŸ¥åœ–å¡æ•¸æ“š (3æ¢/4æ¢ä¸æŠ˜æ¸›) èˆ‡ è¡¨26-2 æ¥åœ°ç·šã€‚</p>
            <div style="text-align:center; margin-top:20px;">
                <button onclick="document.getElementById('helpModal').style.display='none'" class="btn" style="width:auto; padding:10px 30px;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script>
        // è³‡æ–™åº«ï¼šæ¥åœ°ç·š
        const db_ground_image = [
            { limit: 20,   s: "1.6mm", area: 12.6 }, { limit: 30,   s: "2.0mm", area: 12.6 },
            { limit: 60,   s: "5.5mmÂ²", area: 28.3 }, { limit: 100,  s: "8mmÂ²",   area: 44.2 },
            { limit: 200,  s: "14mmÂ²",  area: 63.6 }, { limit: 400,  s: "22mmÂ²",  area: 95.0 },
            { limit: 600,  s: "38mmÂ²",  area: 147 }, { limit: 800,  s: "50mmÂ²",  area: 184 },
            { limit: 1000, s: "60mmÂ²",  area: 219 }, { limit: 1200, s: "80mmÂ²",  area: 275 },
            { limit: 1600, s: "100mmÂ²", area: 340 }, { limit: 2000, s: "125mmÂ²", area: 415 },
            { limit: 2500, s: "175mmÂ²", area: 550 }, { limit: 3000, s: "200mmÂ²", area: 615 },
            { limit: 4000, s: "250mmÂ²", area: 755 }, { limit: 5000, s: "350mmÂ²", area: 1050 },
            { limit: 6000, s: "400mmÂ²", area: 1200 }
        ];

        // è³‡æ–™åº«ï¼šä¸»ç·š (v3:3æ¢å®¹é‡, v4:4æ¢å®¹é‡, n:æ•¸å€¼å¤§å°)
        const db_pvc_wire_img = [
            { s: "1.6mm", v3: 15, v4: 15, a: 10.2, n: 2 }, { s: "2.0mm", v3: 20, v4: 20, a: 12.6, n: 3.5 }, 
            { s: "3.5mmÂ²", v3: 20, v4: 20, a: 19.6, n: 3.5 }, { s: "5.5mmÂ²", v3: 30, v4: 28, a: 28.3, n: 5.5 },
            { s: "8mmÂ²",   v3: 40, v4: 35, a: 44.2, n: 8 }, { s: "14mmÂ²",  v3: 55, v4: 50, a: 63.6, n: 14 },
            { s: "22mmÂ²",  v3: 70, v4: 65, a: 95.0, n: 22 }, { s: "30mmÂ²",  v3: 90, v4: 80, a: 123, n: 30 },
            { s: "38mmÂ²",  v3: 100, v4: 90, a: 147, n: 38 }, { s: "50mmÂ²",  v3: 120, v4: 110, a: 184, n: 50 },
            { s: "60mmÂ²",  v3: 140, v4: 125, a: 219, n: 60 }, { s: "80mmÂ²",  v3: 165, v4: 145, a: 275, n: 80 },
            { s: "100mmÂ²", v3: 190, v4: 170, a: 340, n: 100 }, { s: "125mmÂ²", v3: 220, v4: 200, a: 415, n: 125 },
            { s: "150mmÂ²", v3: 250, v4: 225, a: 483, n: 150 }, { s: "200mmÂ²", v3: 300, v4: 270, a: 615, n: 200 },
            { s: "250mmÂ²", v3: 355, v4: 315, a: 755, n: 250 }, { s: "325mmÂ²", v3: 415, v4: 370, a: 962, n: 325 }
        ];

        const db_pvc_cable_img = [
            { s: "1.6mm", v3: 15, v4: 13, a: 35, n: 2 }, { s: "2.0mm", v3: 19, v4: 16, a: 35, n: 3.5 },
            { s: "3.5mmÂ²", v3: 19, v4: 16, a: 42, n: 3.5 }, { s: "5.5mmÂ²", v3: 25, v4: 23, a: 55, n: 5.5 },
            { s: "8mmÂ²",   v3: 33, v4: 30, a: 70, n: 8 }, { s: "14mmÂ²",  v3: 50, v4: 40, a: 100, n: 14 },
            { s: "22mmÂ²",  v3: 60, v4: 55, a: 150, n: 22 }, { s: "30mmÂ²",  v3: 75, v4: 65, a: 200, n: 30 },
            { s: "38mmÂ²",  v3: 85, v4: 75, a: 230, n: 38 }, { s: "50mmÂ²",  v3: 100, v4: 90, a: 300, n: 50 },
            { s: "60mmÂ²",  v3: 115, v4: 105, a: 360, n: 60 }, { s: "80mmÂ²",  v3: 140, v4: 125, a: 450, n: 80 },
            { s: "100mmÂ²", v3: 160, v4: 150, a: 560, n: 100 }, { s: "125mmÂ²", v3: 185, v4: 165, a: 650, n: 125 },
            { s: "150mmÂ²", v3: 215, v4: 190, a: 750, n: 150 }, { s: "200mmÂ²", v3: 255, v4: 225, a: 900, n: 200 },
            { s: "250mmÂ²", v3: 300, v4: 265, a: 1100, n: 250 }, { s: "325mmÂ²", v3: 355, v4: 310, a: 1350, n: 325 }
        ];

        const db_pex_img = [
            { s: "2.0mmÂ²", v3: 25, v4: 20, a: 21.2, n: 2 }, { s: "3.5mmÂ²", v3: 30, v4: 24, a: 26.4, n: 3.5 },
            { s: "5.5mmÂ²", v3: 40, v4: 32, a: 36.3, n: 5.5 }, { s: "8mmÂ²",   v3: 55, v4: 48, a: 47.8, n: 8 },
            { s: "14mmÂ²",  v3: 75, v4: 70, a: 67.9, n: 14 }, { s: "22mmÂ²",  v3: 100, v4: 90, a: 98.5, n: 22 },
            { s: "30mmÂ²",  v3: 125, v4: 110, a: 127, n: 30 }, { s: "38mmÂ²",  v3: 145, v4: 130, a: 154, n: 38 },
            { s: "50mmÂ²",  v3: 170, v4: 150, a: 191, n: 50 }, { s: "60mmÂ²",  v3: 195, v4: 175, a: 227, n: 60 },
            { s: "80mmÂ²",  v3: 230, v4: 205, a: 284, n: 80 }, { s: "100mmÂ²", v3: 265, v4: 240, a: 350, n: 100 },
            { s: "125mmÂ²", v3: 310, v4: 275, a: 423, n: 125 }, { s: "150mmÂ²", v3: 355, v4: 315, a: 491, n: 150 },
            { s: "200mmÂ²", v3: 420, v4: 380, a: 625, n: 200 }, { s: "250mmÂ²", v3: 500, v4: 450, a: 765, n: 250 },
            { s: "325mmÂ²", v3: 580, v4: 525, a: 973, n: 325 }, { s: "400mmÂ²", v3: 670, v4: 600, a: 1150, n: 400 },
            { s: "500mmÂ²", v3: 755, v4: 680, a: 1400, n: 500 }
        ];

        // å®¹å™¨è³‡æ–™åº«
        const pipe_emt = [ 
            { name: "E19 (3/4\")",  area: 286 }, { name: "E25 (1\")",    area: 506 },
            { name: "E31 (1-1/4\")", area: 872 }, { name: "E39 (1-1/2\")", area: 1195 },
            { name: "E51 (2\")",    area: 2042 }, { name: "E63 (2-1/2\")", area: 3060 },
            { name: "E75 (3\")",    area: 4675 }
        ];
        const pipe_pvc = [ 
            { name: "16mm", area: 162 }, { name: "20mm", area: 287 }, { name: "28mm", area: 512 },
            { name: "35mm", area: 812 }, { name: "41mm", area: 1162 }, { name: "52mm", area: 2000 },
            { name: "65mm", area: 2950 }, { name: "80mm", area: 4450 }
        ];
        const pipe_rsc = [
             { name: "G16", area: 212 }, { name: "G22", area: 387 }, { name: "G28", area: 650 },
             { name: "G36", area: 1137 }, { name: "G42", area: 1537 }, { name: "G54", area: 2525 },
             { name: "G70", area: 3687 }, { name: "G82", area: 5700 }
        ];
        const tray_sizes = [
            { name: "50x50 ç·šæ§½", area: 2500 }, { name: "100x50 ç·šæ§½", area: 5000 },
            { name: "100x100 ç·šæ§½", area: 10000 }, { name: "150x100 ç·šæ§½", area: 15000 },
            { name: "200x100 ç·šæ§½", area: 20000 }, { name: "300x100 ç·šæ§½", area: 30000 },
            { name: "400x100 ç·šæ§½", area: 40000 }, { name: "500x100 ç·šæ§½", area: 50000 },
            { name: "600x100 ç·šæ§½", area: 60000 }
        ];

        function updateHint() {
            const type = document.getElementById('containerType').value;
            const hint = document.getElementById('containerHint');
            if(type === 'tray') hint.innerText = "å¡«å……ç‡ 20%";
            else hint.innerText = "å¡«å……ç‡ 40%";
        }

        function calculate() {
            const nfbAT = parseFloat(document.getElementById('nfbValue').value);
            const userSafety = parseFloat(document.getElementById('safetyFactor').value) || 1.2;
            const circuitConfig = document.getElementById('circuitConfig').value;
            const wireType = document.getElementById('wireType').value;
            const containerType = document.getElementById('containerType').value;
            const wireCountSel = document.getElementById('wireCountSelect').value;

            if (!nfbAT || nfbAT <= 0) { alert("è«‹è¼¸å…¥ NFB AT å€¼"); return; }

            // 1. DB
            let db = null;
            if (wireType === 'pvc_wire') db = db_pvc_wire_img;
            else if (wireType === 'pvc_cable') db = db_pvc_cable_img;
            else db = db_pex_img;

            const isFourWire = (wireCountSel === "4");
            const configText = isFourWire ? "ç®¡å…§4æ¢" : "ç®¡å…§3æ¢";

            // 2. æ±ºå®šè¿´è·¯é‚è¼¯
            let bestSet = null;
            let startSet = 1, endSet = 10;

            if (circuitConfig !== 'auto') {
                startSet = parseInt(circuitConfig);
                endSet = parseInt(circuitConfig); // å¼·åˆ¶åªç®—è©²è¿´è·¯æ•¸
            }

            // 3. Loop
            for (let sets = startSet; sets <= endSet; sets++) {
                
                let requiredAmp = (nfbAT * userSafety) / sets;
                let found = null;

                for (let w of db) {
                    let capacity = isFourWire ? w.v4 : w.v3;
                    if (capacity >= requiredAmp) {
                        found = w;
                        break; 
                    }
                }

                if (circuitConfig === 'auto') {
                    // è‡ªå‹•æ¨¡å¼ï¼šéœ€ç¬¦åˆ < 200mm2
                    if (found && found.n <= 200) {
                        bestSet = { sets: sets, wire: found, capacity: (isFourWire ? found.v4 : found.v3) };
                        break; 
                    }
                } else {
                    // å¼·åˆ¶æ¨¡å¼ï¼šåªè¦æ‰¾åˆ°å°±å›å‚³ (å³ä½¿å¾ˆå¤§æˆ–è¶…å‡º200)
                    if (found) {
                        bestSet = { sets: sets, wire: found, capacity: (isFourWire ? found.v4 : found.v3) };
                        break; 
                    }
                }
            }

            // æ¥åœ°
            let foundGround = null;
            for (let g of db_ground_image) {
                if (g.limit >= nfbAT) { foundGround = g; break; }
            }
            if(!foundGround && nfbAT > 0) foundGround = db_ground_image[db_ground_image.length-1];

            // é¡¯ç¤º
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('resNFBDisplay').innerText = nfbAT;

            const configTag = document.getElementById('configTag');
            configTag.innerHTML = circuitConfig === 'auto' ? 
                '<span class="tag tag-auto">è‡ªå‹•</span>' : 
                '<span class="tag tag-manual">æŒ‡å®š</span>';

            if (bestSet) {
                const sets = bestSet.sets;
                const wire = bestSet.wire;
                
                document.getElementById('resTargetTotal').innerText = (nfbAT * userSafety).toFixed(1);
                document.getElementById('resCalcDetailLine').innerText = 
                    `${sets}è¿´è·¯ x ${bestSet.capacity}A = ${(bestSet.capacity * sets).toFixed(1)}A`;

                if (sets > 1) {
                    document.getElementById('resWireSize').innerText = `${sets} çµ„ x ${wire.s}`;
                } else {
                    document.getElementById('resWireSize').innerText = wire.s;
                }

                if (foundGround) document.getElementById('resGroundSize').innerText = foundGround.s;
                else document.getElementById('resGroundSize').innerText = "ç„¡";

                // å®¹å™¨
                let mainCountPerSet = parseInt(wireCountSel); 
                let totalArea = (wire.a * mainCountPerSet * sets);
                if (foundGround) totalArea += foundGround.area;

                const isTray = (containerType === 'tray');
                let containerDB = [];
                let limitRatio = isTray ? 0.2 : 0.4;
                let areaForCheck = totalArea;
                
                if (isTray) {
                    containerDB = tray_sizes;
                    document.getElementById('resPipeNote').style.display = 'none';
                } else {
                    if (containerType === 'conduit_emt') containerDB = pipe_emt;
                    else if (containerType === 'conduit_pvc') containerDB = pipe_pvc;
                    else containerDB = pipe_rsc;

                    if (sets > 1) {
                        let singlePipeArea = (wire.a * mainCountPerSet);
                        if(foundGround) singlePipeArea += foundGround.area; 
                        areaForCheck = singlePipeArea;
                        document.getElementById('resPipeCount').innerText = sets;
                        document.getElementById('resPipeNote').style.display = 'block';
                    } else {
                        document.getElementById('resPipeNote').style.display = 'none';
                    }
                }

                let foundContainer = null;
                for (let c of containerDB) {
                    if ((c.area * limitRatio) >= areaForCheck) { foundContainer = c; break; }
                }

                document.getElementById('resTotalArea').innerText = totalArea.toFixed(1);

                if (foundContainer) {
                    document.getElementById('resContainerSize').innerText = foundContainer.name;
                    const realRate = (areaForCheck / foundContainer.area) * 100;
                    document.getElementById('resFillRate').innerText = `${realRate.toFixed(1)}%`;
                } else {
                    document.getElementById('resContainerSize').innerText = "è¶…å‡ºè¦æ ¼";
                    document.getElementById('resFillRate').innerText = "-";
                }

            } else {
                document.getElementById('resWireSize').innerText = "ç„¡é©åˆç·šå¾‘";
                document.getElementById('resContainerSize').innerText = "-";
            }
        }

        function openModal() { document.getElementById('helpModal').style.display = 'flex'; }
        function closeModal(e) { if (e.target.className === 'modal') document.getElementById('helpModal').style.display = 'none'; }
    </script>
</body>
</html>
