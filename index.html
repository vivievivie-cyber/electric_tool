<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>線徑與管徑規劃計算機</title>
    <style>
        /* --- 液態玻璃風格 (Liquid Glass) --- */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --primary: #007AFF;
            --text-main: #1d1d1f;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro TC", "Segoe UI", Roboto, sans-serif; 
            margin: 0; padding: 20px; 
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            min-height: 100vh; color: var(--text-main);
            padding-bottom: 120px;
        }

        /* 背景流動光球 */
        .blob-cont { position: fixed; top:0; left:0; width:100%; height:100%; z-index:-1; overflow:hidden; }
        .blob { position: absolute; border-radius: 50%; filter: blur(50px); opacity: 0.6; animation: move 10s infinite alternate; }
        .b1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #a18cd1; }
        .b2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #fbc2eb; animation-delay: -5s; }
        @keyframes move { from { transform: translate(0,0); } to { transform: translate(20px, 30px); } }

        /* 標題 */
        .header-container { text-align: center; margin-bottom: 25px; position: relative; }
        h1 { 
            margin: 0; font-size: 1.6rem; font-weight: 700; color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* 說明按鈕 */
        .help-btn {
            position: absolute; right: 0; top: 0;
            background: rgba(255,255,255,0.4); border: 1px solid #fff;
            width: 32px; height: 32px; border-radius: 50%;
            color: #fff; font-weight: bold; cursor: pointer;
            backdrop-filter: blur(4px);
        }

        /* 玻璃卡片 */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px; padding: 24px;
            box-shadow: var(--glass-shadow);
            margin-bottom: 20px;
        }

        /* 輸入區 */
        .input-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #333; }
        
        select, input { 
            width: 100%; padding: 14px; 
            border: 1px solid rgba(255,255,255,0.5); border-radius: 16px;
            font-size: 18px; background: rgba(255,255,255,0.5);
            box-sizing: border-box; appearance: none; color: #000;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
            transition: 0.3s;
        }
        select:focus, input:focus { 
            outline: none; background: #fff; border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0,122,255,0.15);
        }

        /* 按鈕 */
        .btn { 
            display: block; width: 100%; padding: 16px; border: none; border-radius: 18px; 
            font-size: 1.1rem; font-weight: 600; cursor: pointer; color: white; margin-top: 10px;
            background: linear-gradient(135deg, #007AFF, #0056b3);
            box-shadow: 0 10px 20px rgba(0,122,255,0.25);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }

        /* 結果展示 */
        .result-section { display: none; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

        .res-block { border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 15px; margin-bottom: 15px; }
        .res-block:last-child { border-bottom: none; margin-bottom: 0; }
        
        .res-title { font-size: 0.85rem; color: #666; font-weight: bold; margin-bottom: 5px; }
        .res-value { font-size: 1.6rem; font-weight: 800; color: #1d1d1f; margin-bottom: 4px; }
        .res-detail { font-size: 0.9rem; color: #555; }
        .hl { color: var(--primary); font-weight: bold; }

        /* Modal */
        .modal {
            display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(5px);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: #fff; padding: 30px; border-radius: 24px; width: 85%; max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); position: relative;
        }
        .close-x { position: absolute; right: 20px; top: 15px; font-size: 24px; color: #999; cursor: pointer; }
    </style>
</head>
<body>

    <div class="blob-cont"><div class="blob b1"></div><div class="blob b2"></div></div>

    <div class="header-container">
        <h1>線徑與管徑規劃計算機</h1>
        <button class="help-btn" onclick="openModal()">?</button>
    </div>

    <div class="glass-card">
        <div class="input-group">
            <label>1. 無熔絲開關 (NFB AT)</label>
            <input type="number" id="nfbValue" placeholder="輸入 AT 值 (如 50, 400)" inputmode="decimal">
        </div>

        <div class="input-group">
            <label>2. 電線安全係數</label>
            <input type="number" id="safetyFactor" value="1.2" step="0.1" inputmode="decimal">
        </div>

        <div class="input-group">
            <label>3. 迴路配置方式</label>
            <select id="circuitConfig">
                <option value="auto">✨ 自動計算 (優先單路, >200mm²分路)</option>
                <option value="1">強制 1 迴路</option>
                <option value="2">強制 2 迴路</option>
                <option value="3">強制 3 迴路</option>
                <option value="4">強制 4 迴路</option>
            </select>
        </div>

        <div class="input-group">
            <label>4. 絕緣導線種類</label>
            <select id="wireType">
                <option value="xlpe">XLPE 電纜 (PEX/CV) - 90°C</option>
                <option value="pvc_wire">PVC 電線 (IV) - 60°C</option>
                <option value="pvc_cable">PVC 電纜 (VV) - 60°C</option>
            </select>
        </div>
        
        <div class="input-group">
            <label>5. 容器與導線數</label>
            <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 10px;">
                <select id="containerType" onchange="updateLabel()">
                    <option value="conduit_emt">導線管 (EMT)</option>
                    <option value="conduit_pvc">導線管 (PVC)</option>
                    <option value="conduit_rsc">導線管 (RSG)</option>
                    <option value="tray">金屬線槽</option>
                </select>
                <select id="wireCountSelect">
                    <option value="3">3 條</option>
                    <option value="4">4 條</option>
                </select>
            </div>
        </div>

        <button class="btn" onclick="calculate()">自動計算</button>
    </div>

    <div id="resultArea" class="result-section glass-card">
        
        <div class="res-block">
            <div class="res-title">步驟一：建議主線徑</div>
            <div class="res-value" id="resWireSize">---</div>
            <div class="res-detail">
                目標容量：<span id="resTargetTotal" class="hl">0</span> A <span style="font-size:0.8em;color:#777">(含係數)</span><br>
                <span id="resCalcDetailLine"></span>
            </div>
        </div>

        <div class="res-block">
            <div class="res-title">步驟二：銅接地線 (G)</div>
            <div class="res-value" id="resGroundSize" style="color:#34C759;">---</div>
            <div class="res-detail">依據表 26-2 (NFB <span id="resNFBDisplay">0</span>A)</div>
        </div>

        <div class="res-block">
            <div class="res-title" id="pipeTitle">步驟三：建議配管管徑</div>
            <div class="res-value" id="resContainerSize">---</div>
            <div class="res-detail">
                <div id="resPipeNote" style="display:none; color:#ff9500; font-weight:bold; margin-bottom:4px;">
                    ⚠️ 需配置 <span id="resPipeCount">1</span> 支管 (每管一迴路)
                </div>
                總截面積：<span id="resTotalArea">0</span> mm²<br>
                <span id="resFillInfo">填充率：0%</span>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-x" onclick="document.getElementById('helpModal').style.display='none'">&times;</span>
            <h3 style="margin-top:0;">設定說明</h3>
            <p><strong>1. 安全係數：</strong><br>預設 1.2 倍。若 NFB 為 100A，則線徑需能承受 120A。</p>
            <p><strong>2. 迴路選擇：</strong><br>「自動」模式下，若單線超過 200mm²，系統會自動拆分為多迴路以利施工。</p>
            <p><strong>3. 管徑計算：</strong><br>已校正為台灣市售電纜標準外徑，確保計算結果精準。</p>
        </div>
    </div>

    <script>
        // --- 資料庫：接地線 (依表26-2, a=外徑面積) ---
        // 修正：依據 IV 線外徑估算接地線佔用面積
        const db_ground = [
            { limit: 20,   s: "1.6mm", a: 11 }, { limit: 30,   s: "2.0mm", a: 13 },
            { limit: 60,   s: "5.5mm²", a: 28 }, { limit: 100,  s: "8mm²",   a: 44 },
            { limit: 200,  s: "14mm²",  a: 64 }, { limit: 400,  s: "22mm²",  a: 95 },
            { limit: 600,  s: "38mm²",  a: 147 }, { limit: 800,  s: "50mm²",  a: 184 },
            { limit: 1000, s: "60mm²",  a: 219 }, { limit: 1200, s: "80mm²",  a: 275 },
            { limit: 4000, s: "100mm²", a: 340 } // 法規最大到100
        ];

        // --- 資料庫：主線 (v3/v4:查表容量, a:完成外徑截面積, n:數值) ---
        // ★ 重大修正：Area (a) 依據各大廠牌 600V 電纜平均外徑校正，避免管徑計算過大
        
        const db_pvc_wire_img = [ // PVC IV
            { s: "1.6mm", v3: 15, v4: 15, a: 11, n: 2 },
            { s: "2.0mm", v3: 20, v4: 20, a: 13, n: 3.5 },
            { s: "3.5mm²", v3: 20, v4: 20, a: 20, n: 3.5 },
            { s: "5.5mm²", v3: 30, v4: 28, a: 29, n: 5.5 },
            { s: "8mm²",   v3: 40, v4: 35, a: 45, n: 8 },
            { s: "14mm²",  v3: 55, v4: 50, a: 64, n: 14 },
            { s: "22mm²",  v3: 70, v4: 65, a: 96, n: 22 },
            { s: "30mm²",  v3: 90, v4: 80, a: 123, n: 30 },
            { s: "38mm²",  v3: 100, v4: 90, a: 148, n: 38 },
            { s: "50mm²",  v3: 120, v4: 110, a: 185, n: 50 },
            { s: "60mm²",  v3: 140, v4: 125, a: 220, n: 60 },
            { s: "80mm²",  v3: 165, v4: 145, a: 275, n: 80 },
            { s: "100mm²", v3: 190, v4: 170, a: 340, n: 100 },
            { s: "125mm²", v3: 220, v4: 200, a: 416, n: 125 },
            { s: "150mm²", v3: 250, v4: 225, a: 483, n: 150 },
            { s: "200mm²", v3: 300, v4: 270, a: 616, n: 200 },
            { s: "250mm²", v3: 355, v4: 315, a: 755, n: 250 },
            { s: "325mm²", v3: 415, v4: 370, a: 962, n: 325 }
        ];

        const db_pvc_cable_img = [ // PVC VV (Cable) - Area 較大
            { s: "2.0mm", v3: 19, v4: 16, a: 36, n: 3.5 },
            { s: "3.5mm²", v3: 19, v4: 16, a: 43, n: 3.5 },
            { s: "5.5mm²", v3: 25, v4: 23, a: 56, n: 5.5 },
            { s: "8mm²",   v3: 33, v4: 30, a: 72, n: 8 },
            { s: "14mm²",  v3: 50, v4: 40, a: 100, n: 14 },
            { s: "22mm²",  v3: 60, v4: 55, a: 150, n: 22 },
            { s: "30mm²",  v3: 75, v4: 65, a: 200, n: 30 },
            { s: "38mm²",  v3: 85, v4: 75, a: 230, n: 38 },
            { s: "50mm²",  v3: 100, v4: 90, a: 300, n: 50 },
            { s: "60mm²",  v3: 115, v4: 105, a: 360, n: 60 },
            { s: "80mm²",  v3: 140, v4: 125, a: 450, n: 80 },
            { s: "100mm²", v3: 160, v4: 150, a: 560, n: 100 },
            { s: "125mm²", v3: 185, v4: 165, a: 650, n: 125 },
            { s: "150mm²", v3: 215, v4: 190, a: 750, n: 150 },
            { s: "200mm²", v3: 255, v4: 225, a: 900, n: 200 },
            { s: "250mm²", v3: 300, v4: 265, a: 1100, n: 250 },
            { s: "325mm²", v3: 355, v4: 310, a: 1350, n: 325 }
        ];

        const db_pex_img = [ // XLPE (CV) - Area 修正為標準值 (較之前版本小)
            { s: "2.0mm²", v3: 25, v4: 20, a: 23, n: 2 },
            { s: "3.5mm²", v3: 30, v4: 24, a: 28, n: 3.5 },
            { s: "5.5mm²", v3: 40, v4: 32, a: 38, n: 5.5 },
            { s: "8mm²",   v3: 55, v4: 48, a: 42, n: 8 },
            { s: "14mm²",  v3: 75, v4: 70, a: 68, n: 14 },
            { s: "22mm²",  v3: 100, v4: 90, a: 90, n: 22 },
            { s: "30mm²",  v3: 125, v4: 110, a: 128, n: 30 },
            { s: "38mm²",  v3: 145, v4: 130, a: 155, n: 38 },
            { s: "50mm²",  v3: 170, v4: 150, a: 190, n: 50 },
            { s: "60mm²",  v3: 195, v4: 175, a: 225, n: 60 },
            { s: "80mm²",  v3: 230, v4: 205, a: 285, n: 80 },
            { s: "100mm²", v3: 265, v4: 240, a: 355, n: 100 },
            { s: "125mm²", v3: 310, v4: 275, a: 430, n: 125 },
            { s: "150mm²", v3: 355, v4: 315, a: 500, n: 150 },
            { s: "200mm²", v3: 420, v4: 380, a: 640, n: 200 },
            { s: "250mm²", v3: 500, v4: 450, a: 780, n: 250 },
            { s: "325mm²", v3: 580, v4: 525, a: 990, n: 325 }
        ];

        // 容器資料庫 (Area: 總內截面積)
        // 擴充大管徑 (3.5", 4") 以支援大電流分路
        const pipe_emt = [ 
            { name: "E19 (3/4\")",  area: 286 }, { name: "E25 (1\")",    area: 506 },
            { name: "E31 (1-1/4\")", area: 872 }, { name: "E39 (1-1/2\")", area: 1195 },
            { name: "E51 (2\")",    area: 2042 }, { name: "E63 (2-1/2\")", area: 3060 },
            { name: "E75 (3\")",    area: 4675 }, 
            { name: "E92 (3-1/2\")", area: 6000 }, { name: "E104 (4\")",   area: 7850 }
        ];
        const pipe_pvc = [ 
            { name: "16mm", area: 162 }, { name: "20mm", area: 287 }, { name: "28mm", area: 512 },
            { name: "35mm", area: 812 }, { name: "41mm", area: 1162 }, { name: "52mm", area: 2000 },
            { name: "65mm", area: 2950 }, { name: "80mm", area: 4450 },
            { name: "100mm (4\")", area: 6800 }
        ];
        const pipe_rsc = [
             { name: "G16", area: 212 }, { name: "G22", area: 387 }, { name: "G28", area: 650 },
             { name: "G36", area: 1137 }, { name: "G42", area: 1537 }, { name: "G54", area: 2525 },
             { name: "G70", area: 3687 }, { name: "G82", area: 5700 },
             { name: "G92 (3-1/2\")", area: 7200 }, { name: "G104 (4\")",   area: 9200 }
        ];
        const tray_sizes = [
            { name: "50x50 線槽", area: 2500 }, { name: "100x50 線槽", area: 5000 },
            { name: "100x100 線槽", area: 10000 }, { name: "150x100 線槽", area: 15000 },
            { name: "200x100 線槽", area: 20000 }, { name: "300x100 線槽", area: 30000 },
            { name: "400x100 線槽", area: 40000 }, { name: "500x100 線槽", area: 50000 },
            { name: "600x100 線槽", area: 60000 }
        ];

        function updateLabel() {
            const type = document.getElementById('containerType').value;
            const title = document.getElementById('pipeTitle');
            // 客製化需求：若為線槽，邏輯改變但標題依使用者要求顯示
            // 若需要動態變更標題可在此打開，目前依要求顯示"建議配管管徑"
            // if(type === 'tray') title.innerText = "步驟三：建議線槽尺寸";
            // else title.innerText = "步驟三：建議配管管徑";
        }

        function calculate() {
            const nfbAT = parseFloat(document.getElementById('nfbValue').value);
            const userSafety = parseFloat(document.getElementById('safetyFactor').value) || 1.2;
            const circuitConfig = document.getElementById('circuitConfig').value;
            const wireType = document.getElementById('wireType').value;
            const containerType = document.getElementById('containerType').value;
            const wireCountSel = document.getElementById('wireCountSelect').value;

            if (!nfbAT || nfbAT <= 0) { alert("請輸入 NFB AT 值"); return; }

            // 1. 選擇資料庫
            let db = null;
            if (wireType === 'pvc_wire') db = db_pvc_wire_img;
            else if (wireType === 'pvc_cable') db = db_pvc_cable_img;
            else db = db_pex_img;

            const isFourWire = (wireCountSel === "4");

            // 2. 決定迴路與線徑
            let bestSet = null;
            let startSet = 1, endSet = 10;

            if (circuitConfig !== 'auto') {
                startSet = parseInt(circuitConfig);
                endSet = parseInt(circuitConfig);
            }

            for (let sets = startSet; sets <= endSet; sets++) {
                let requiredAmp = (nfbAT * userSafety) / sets;
                let found = null;

                for (let w of db) {
                    let capacity = isFourWire ? w.v4 : w.v3;
                    if (capacity >= requiredAmp) {
                        found = w;
                        break; 
                    }
                }

                if (circuitConfig === 'auto') {
                    if (found && found.n <= 200) {
                        bestSet = { sets: sets, wire: found, capacity: (isFourWire ? found.v4 : found.v3) };
                        break; 
                    }
                } else {
                    if (found) {
                        bestSet = { sets: sets, wire: found, capacity: (isFourWire ? found.v4 : found.v3) };
                        break; 
                    }
                }
            }

            // 3. 接地線 (依總 NFB)
            let foundGround = null;
            for (let g of db_ground) {
                if (g.limit >= nfbAT) { foundGround = g; break; }
            }
            if(!foundGround && nfbAT > 0) foundGround = db_ground[db_ground.length-1];

            // 4. 顯示與管徑計算
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('resNFBDisplay').innerText = nfbAT;

            if (bestSet) {
                const sets = bestSet.sets;
                const wire = bestSet.wire;
                
                document.getElementById('resTargetTotal').innerText = (nfbAT * userSafety).toFixed(1);
                
                let detailText = `單線耐流 ${bestSet.capacity}A`;
                if (sets > 1) {
                    document.getElementById('resWireSize').innerText = `${sets} 迴路 x ${wire.s}`;
                    detailText += ` (x${sets}路)`;
                } else {
                    document.getElementById('resWireSize').innerText = wire.s;
                }
                document.getElementById('resCalcDetailLine').innerText = detailText;

                // 接地
                if (foundGround) document.getElementById('resGroundSize').innerText = foundGround.s;
                else document.getElementById('resGroundSize').innerText = "無";

                // 計算容器 (管/槽)
                // 管內邏輯：主線 * 條數 + 接地 * 1
                // 併聯邏輯：若併聯，預設分管配置 (每管一組主線+接地)
                
                let mainCount = parseInt(wireCountSel); 
                // 單一管內的面積 (單迴路面積)
                let areaCheck = (wire.a * mainCount);
                if (foundGround) areaCheck += foundGround.a; // 每管帶一條接地

                // 總面積 (線槽用)
                let totalAreaForTray = (wire.a * mainCount * sets);
                if (foundGround) totalAreaForTray += foundGround.a; // 線槽共用一條大接地

                const isTray = (containerType === 'tray');
                let containerDB = [];
                let limitRatio = isTray ? 0.2 : 0.4;
                
                // 決定要用哪種面積去查表
                let finalCheckArea = isTray ? totalAreaForTray : areaCheck;

                if (isTray) {
                    containerDB = tray_sizes;
                    document.getElementById('resPipeNote').style.display = 'none';
                } else {
                    if (containerType === 'conduit_emt') containerDB = pipe_emt;
                    else if (containerType === 'conduit_pvc') containerDB = pipe_pvc;
                    else containerDB = pipe_rsc;

                    if (sets > 1) {
                        document.getElementById('resPipeCount').innerText = sets;
                        document.getElementById('resPipeNote').style.display = 'block';
                    } else {
                        document.getElementById('resPipeNote').style.display = 'none';
                    }
                }

                let foundContainer = null;
                for (let c of containerDB) {
                    // 法規檢討: 容器可用面積 >= 線總面積
                    if ((c.area * limitRatio) >= finalCheckArea) { 
                        foundContainer = c; break; 
                    }
                }

                document.getElementById('resTotalArea').innerText = finalCheckArea.toFixed(1);
                
                if (foundContainer) {
                    document.getElementById('resContainerSize').innerText = foundContainer.name;
                    const rate = (finalCheckArea / foundContainer.area) * 100;
                    document.getElementById('resFillInfo').innerText = 
                        `填充率：${rate.toFixed(1)}% (上限 ${limitRatio*100}%)`;
                } else {
                    document.getElementById('resContainerSize').innerText = "超出規格";
                    document.getElementById('resFillInfo').innerText = "-";
                }

            } else {
                document.getElementById('resWireSize').innerText = "無適合線徑";
                document.getElementById('resContainerSize').innerText = "-";
            }
        }

        function openModal() { document.getElementById('helpModal').style.display = 'flex'; }
        function closeModal(e) { if (e.target.className === 'modal') document.getElementById('helpModal').style.display = 'none'; }
    </script>
</body>
</html>
